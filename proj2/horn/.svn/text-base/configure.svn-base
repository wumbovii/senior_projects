#!/bin/sh

src="`cd \`dirname $0\`; pwd`"

Usage () {
    echo "Usage: DIR/configure [ OPTION ... ]
    where OPTION may be any of these:
       --prefix=PREFIX   Base installation directory (default $HOME).
       --bindir=DIR      Executables' directory (default PREFIX/bin).
       --datadir=DIR     Templates (default PREFIX/lib/horn).
       --with-python=PATH
       --with-bison=PATH
       --with-flex=PATH
                         Locations of Python, Bison, and Flex (default: taken
			 from PATH at time of configuration)."
}

fullpath () {
    if expr "$1" : '^/' >/dev/null; then
        echo "$1";
    else
        echo "`pwd`/$1";
    fi
    return 0
}

findprog () {
    IFS0="$IFS"
    IFS=":"
    for p in $PATH; do
        if [ -x $p/$1 ]; then
	   IFS="$IFS0"
	   echo "$p/$1"; return 0
	fi
    done
    
    echo "Error: $1 not found."; exit 1
}

doconfig () {
    rm -f $2
    sed -e "s,@BINDIR@,$bindir,g" \
        -e "s,@DATADIR@,$datadir,g" \
        -e "s,@PYTHON@,$python,g" \
	-e "s,@BISON@,$bison,g" \
	-e "s,@FLEX@,$flex,g" \
	-e "s,@SRCDIR@,$src,g" \
	-e "s,%%,@,g" \
       "$1" > "$2" || { echo "Could not generate $2"; exit 1; }
    if [ -x "$1" ]; then
       chmod a+rx "$2"
    fi
    echo "Configured $2"
}

prefix=
bindir=
datadir=
python=
bison=
flex=

cmnd="$0 $@"
cmnd="$0"
for arg in "$@"; do
    cmnd="$cmnd '$arg'"
done

while [ $# -gt 0 ]; do
    arg="`echo $1 | sed 's/.*=//'`"
    case "$1" in
    --prefix=*)      prefix="`fullpath $arg`";;
    --bindir=*)      bindir="`fullpath $arg`";;
    --datadir=*)     datadir="`fullpath $arg`";;
    --with-python=*) python="$arg";;
    --with-bison=*)  bison="$arg";;
    --with-flex=*)   flex="$arg";;
    *)               Usage; exit 1;;
    esac
    shift
done

echo "
# Generated by Horn configure script.
# Run this script through a shell to run configure with its last arguments." \
    > config.status
echo $cmnd >> config.status

if [ -z "$prefix" ]; then
    prefix="$HOME"
fi
if [ -z "$bindir" ]; then
    bindir="$prefix/bin"
fi
if [ -z "$datadir" ]; then
    datadir="$prefix/lib/horn"
fi
if [ -z "$python" ]; then
    python=`findprog python`
fi
if [ -z "$bison" ]; then
    bison=`findprog bison`
fi
if [ -z "$flex" ]; then
    flex=`findprog flex`
fi

doconfig $src/Makefile.in ./Makefile
chmod a-w Makefile
if [ ! -x tests ]; then mkdir tests; fi
doconfig $src/tests/Makefile.in tests/Makefile
